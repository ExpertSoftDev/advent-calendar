<!-- New Year Photo Editor - Updated Version -->
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Новогодний Фото-Редактор</title>
<style>
    body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: url('images/background.jpg') center/cover no-repeat fixed;
    }

    .editor-container {
        display: flex;
        gap: 20px;
        padding: 20px;
        background: rgba(255,255,255,0.2);
        backdrop-filter: blur(8px);
        border-radius: 16px;
        margin: 20px;
    }

    .sidebar {
        width: 260px;
        padding: 20px;
        background: rgba(255,255,255,0.35);
        backdrop-filter: blur(4px);
        border-radius: 16px;
    }

    .sidebar h2 {
        margin-top: 0;
        font-size: 20px;
    }

    .canvas-wrapper {
        position: relative;
        width: 700px;
        height: 700px;
        background: rgba(255,255,255,0.3);
        border-radius: 12px;
        overflow: hidden;
    }

    canvas {
        width: 100%;
        height: 100%;
    }

    button, select, input {
        width: 100%;
        margin-bottom: 10px;
        padding: 10px;
        border-radius: 10px;
        border: none;
        background: rgba(255,255,255,0.8);
    }
</style>
</head>
<body>
<div class="editor-container">
    <div class="sidebar">
        <h2>Фото</h2>
        <input type="file" id="photoLoader" accept="image/*" />

        <h2>Рамки</h2>
        <select id="frameSelector">
            <option value="none">Без рамки</option>
            <option value="frame-snow.png">Снежная рамка</option>
            <option value="frame-ice.png">Ледяная рамка</option>
            <option value="frame-garland.png">Гирлянда</option>
        </select>

        <h2>Украшения</h2>
        <select id="decorSelector">
            <option value="none">Выберите украшение</option>
            <option value="editor_hat-santa.png">Шапка Санты</option>
            <option value="editor_hat-elf.png">Шапка Эльфа</option>
            <option value="editor_ball-red.png">Красный шар</option>
            <option value="editor_ball-blue.png">Синий шар</option>
            <option value="editor_snowflake.png">Снежинка</option>
            <option value="editor_garland.png">Гирлянда</option>
        </select>

        <h2>Фильтры</h2>
        <select id="filterSelector">
            <option value="none">Без фильтра</option>
            <option value="vintage">Винтаж</option>
            <option value="bw">Чёрно-белый</option>
        </select>

        <button id="downloadBtn">Скачать</button>
    </div>

    <div class="canvas-wrapper">
        <canvas id="editorCanvas" width="1000" height="1000"></canvas>
    </div>
</div>

<script>
const canvas = document.getElementById('editorCanvas');
const ctx = canvas.getContext('2d');

let baseImage = null;
let frameImage = null;
let filter = 'none';
let decorations = [];
let scale = 1;
let offsetX = 0;
let offsetY = 0;

// Масштабирование колесиком мыши
canvas.addEventListener('wheel', (e) => {
    e.preventDefault();
    const delta = e.deltaY < 0 ? 1.05 : 0.95;
    scale *= delta;
    drawEditor();
});

// Загрузка фото
photoLoader.addEventListener('change', (e) => {
    const file = e.target.files[0];
    const img = new Image();
    img.onload = () => {
        baseImage = img;
        drawEditor();
    };
    img.src = URL.createObjectURL(file);
});

// Рамки
frameSelector.addEventListener('change', (e) => {
    if (e.target.value === 'none') {
        frameImage = null;
        drawEditor();
        return;
    }
    const img = new Image();
    img.onload = () => {
        frameImage = img;
        drawEditor();
    };
    img.src = `images/${e.target.value}`;
});

// Украшения
canvas.addEventListener('mousedown', (e) => {
    const x = e.offsetX;
    const y = e.offsetY;
    decorations.forEach((d) => {
        if (x > d.x && x < d.x + d.size && y > d.y && y < d.y + d.size) {
            d.dragging = true;
        }
    });
});

canvas.addEventListener('mouseup', () => {
    decorations.forEach((d) => d.dragging = false);
});

canvas.addEventListener('mousemove', (e) => {
    decorations.forEach((d) => {
        if (d.dragging) {
            d.x = e.offsetX - d.size/2;
            d.y = e.offsetY - d.size/2;
            drawEditor();
        }
    });
});

decorSelector.addEventListener('change', (e) => {
    if (e.target.value === 'none') return;
    const img = new Image();
    img.onload = () => {
        decorations.push({ img, x: 200, y: 200, size: 200, dragging: false });
        drawEditor();
    };
    img.src = `images/${e.target.value}`;
});

// Фильтры
filterSelector.addEventListener('change', (e) => {
    filter = e.target.value;
    drawEditor();
});

function applyFilter() {
    if (filter === 'none') return;

    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const data = imageData.data;

    if (filter === 'vintage') {
        for (let i = 0; i < data.length; i += 4) {
            data[i] += 20;
            data[i+1] += 10;
        }
    }

    if (filter === 'bw') {
        for (let i = 0; i < data.length; i += 4) {
            const avg = (data[i]+data[i+1]+data[i+2]) / 3;
            data[i] = data[i+1] = data[i+2] = avg;
        }
    }

    ctx.putImageData(imageData, 0, 0);
}

// Перерисовка
function drawEditor() {
    ctx.clearRect(0,0,canvas.width,canvas.height);

    if (baseImage) {
        const w = baseImage.width * scale;
        const h = baseImage.height * scale;
        ctx.drawImage(baseImage, (canvas.width - w)/2, (canvas.height - h)/2, w, h);
    }

    decorations.forEach((d) => {
        ctx.drawImage(d.img, d.x, d.y, d.size, d.size);
    });

    if (frameImage) {
        ctx.drawImage(frameImage, 0, 0, canvas.width, canvas.height);
    }

    applyFilter();
}

// Скачать

downloadBtn.addEventListener('click', () => {
    const link = document.createElement('a');
    link.download = 'edited-photo.png';
    link.href = canvas.toDataURL('image/png');
    link.click();
});
</script>

</body>
</html>
