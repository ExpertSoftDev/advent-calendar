<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Адвент Expert Soft — Новогодний редактор аватарок</title>
<style>
  :root{
    --content-width:1100px;
    --accent:#f59e0b;
    --glass: rgba(255,255,255,0.06);
    --glass-2: rgba(0,0,0,0.45);
    --muted:#cbd5e1;
    --card-radius:18px;
  }

  html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "SF Pro Text", Roboto, "Segoe UI", Arial, sans-serif;background:
    linear-gradient(145deg,#071025 0%, #0f172a 40%, #071025 100%); color:#fff; -webkit-font-smoothing:antialiased;}

  body::after{
    content:"";
    position:fixed;inset:0;z-index:-2;
    background:
      linear-gradient(to bottom, rgba(15,23,42,0.18), rgba(15,23,42,0.6)),
      url("images/fon-saita.png");
    background-size:cover;background-position:center;opacity:0.95;
  }

  .app {
    max-width: var(--content-width);
    margin: 28px auto;
    padding: 28px;
    border-radius: 28px;
    background: radial-gradient(circle at 0 0, rgba(255,255,255,0.04) 0, rgba(255,255,255,0.02) 30%), rgba(0,0,0,0.35);
    box-shadow: 0 30px 80px rgba(2,6,23,0.7);
    border:1px solid rgba(255,255,255,0.03);
    overflow:hidden;
  }

  header.header {
    display:flex; align-items:center; gap:18px; margin-bottom:18px;
  }
  .brand {
    display:flex; flex-direction:column; gap:4px;
  }
  .brand h1{margin:0;font-size:26px;letter-spacing:0.06em;text-transform:uppercase;}
  .brand p{margin:0;color:var(--muted);font-size:13px;}

  .layout {
    display:grid;
    grid-template-columns: 620px 1fr;
    gap:18px;
  }

  /* Editor column */
  .editor {
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius: var(--card-radius);
    padding:16px;
    min-height:520px;
    display:flex;
    flex-direction:column;
    gap:12px;
    align-items:center;
    justify-content:center;
  }

  .canvas-wrap {
    width: 540px;
    height: 540px;
    border-radius:14px;
    background: linear-gradient(180deg, rgba(0,0,0,0.35), rgba(0,0,0,0.55));
    position:relative;
    overflow:hidden;
    box-shadow: 0 10px 24px rgba(2,6,23,0.6);
    border:1px solid rgba(255,255,255,0.03);
  }

  canvas#preview {
    display:block; width:100%; height:100%; background:transparent;
  }

  .controls {
    display:flex; gap:10px; align-items:center; margin-top:8px; flex-wrap:wrap; justify-content:center;
  }

  .btn {
    background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
    border:1px solid rgba(255,255,255,0.06);
    color:#fff;
    padding:8px 12px;
    border-radius:12px;
    cursor:pointer;
    font-weight:600;
    transition:transform .12s ease, box-shadow .12s;
    user-select:none;
  }
  .btn:hover{transform:translateY(-3px); box-shadow:0 8px 20px rgba(0,0,0,0.5);}
  .btn.secondary { background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.04); }

  .uploader {
    display:flex; gap:10px; align-items:center;
  }

  input[type="file"]{display:none;}

  .hint { font-size:13px;color:var(--muted);text-align:center; }

  /* Right column - tools */
  .tools {
    display:flex; flex-direction:column; gap:12px;
  }

  .card {
    background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
    border-radius:14px; padding:12px; border:1px solid rgba(255,255,255,0.03);
  }
  .card h4 {margin:0 0 8px 0;font-size:15px;}
  .thumbs { display:flex; gap:8px; flex-wrap:wrap; }
  .thumb {
    width:80px;height:80px;border-radius:10px; background:rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:center;
    cursor:pointer;border:1px solid rgba(255,255,255,0.04); overflow:hidden;
  }
  .thumb img{max-width:100%; max-height:100%; display:block;}

  .small {font-size:13px;color:var(--muted);}

  /* selection panel */
  .selected-info {display:flex; gap:8px; align-items:center; justify-content:space-between;}
  .range { width:100%; }
  .tool-row { display:flex; gap:8px; align-items:center; }

  /* footer controls */
  .footer-actions { display:flex; gap:10px; justify-content:center; margin-top:10px; }

  /* responsive */
  @media (max-width:1000px){
    .layout{grid-template-columns: 1fr; }
    .canvas-wrap{width:92%; height:92vw; max-height:640px;}
  }

  /* small helpers for draggable handles (visual only) */
  .help {font-size:13px;color:var(--muted); text-align:center;}
  .muted {color:var(--muted); font-size:13px;}

  /* small UI tweaks for list of decorations */
  .tools .card .thumb.selected{ outline: 3px solid rgba(245,158,11,0.25); box-shadow:0 6px 18px rgba(245,158,11,0.06); }
</style>
</head>
<body>
  <div class="app" role="application" aria-label="Новогодний редактор аватарок в стиле Advent Expert Soft">
    <header class="header">
      <div class="brand">
        <h1>Адвент Expert Soft</h1>
        <p>Создавайте новогодние аватарки — загрузите фото, добавьте рамку, шапку и украшения</p>
      </div>
      <div style="flex:1"></div>
      <div class="muted">Готовый PNG — 1080×1080</div>
    </header>

    <div class="layout">
      <section class="editor">
        <div class="canvas-wrap" id="dropzone" title="Перетащите фото сюда">
          <canvas id="preview" width="540" height="540" aria-label="Предпросмотр аватарки"></canvas>
        </div>

        <div class="controls">
          <label class="btn uploader" for="fileInput">Загрузить фото
            <input id="fileInput" type="file" accept="image/*">
          </label>

          <button class="btn secondary" id="resetBtn" title="Удалить фото и все элементы">Сбросить</button>
          <button class="btn" id="downloadBtn">Скачать аватарку</button>
        </div>

        <div class="hint">Крути колесиком над фото или используй ползунок масштаба (в инструментах) для масштабирования изображения.</div>
      </section>

      <aside class="tools">
        <div class="card">
          <h4>Рамки</h4>
          <div class="thumbs" id="framesList">
            <!-- thumbs inserted by JS -->
          </div>
        </div>

        <div class="card">
          <h4>Шапки и украшения</h4>
          <div class="thumbs" id="hatsList"></div>
        </div>

        <div class="card">
          <h4>Выбранный элемент</h4>
          <div class="selected-info">
            <div>
              <div class="small">Инструменты трансформации</div>
              <div class="tool-row" style="margin-top:8px;">
                <label class="small">Масштаб</label>
                <input id="scaleRange" class="range" type="range" min="0.2" max="3" step="0.01" value="1">
              </div>
              <div class="tool-row" style="margin-top:8px;">
                <label class="small">Поворот</label>
                <input id="rotateRange" class="range" type="range" min="-180" max="180" step="1" value="0">
              </div>
            </div>
            <div style="width:10px"></div>
          </div>
          <div style="height:8px"></div>
          <div class="muted small">Выберите рамку или украшение в списке выше, чтобы изменить размер/поворот.</div>
        </div>

        <div class="card">
          <h4>Подсказки</h4>
          <ul style="margin:8px 0 0 18px;color:var(--muted);font-size:13px">
            <li>Перетащи фото внутри холста — двигай его, чтобы кадрировать.</li>
            <li>Колёсико мыши над холстом — масштаб фото/выбранного элемента.</li>
            <li>Клик по украшению — выбрать/переместить; двойной клик — удалить.</li>
          </ul>
        </div>
      </aside>
    </div>
  </div>

<script>
/*
  Полнофункциональный клиентский редактор аватарок.
  - загружает фото
  - фото можно перетаскивать, масштабировать колёсиком и ползунком
  - добавлять рамки/шапки/украшения (встроенные SVG-dataURI)
  - перетаскивать/масштабировать/вращать украшения
  - экспорт 1080x1080 PNG
*/

/* ---------- встроенные украшения (SVG как data-URI) ---------- */
/* Я добавил небольшой набор — при желании позже заменим на ваши PNG */
const ASSETS = {
  frames: [
    { id: 'frame-gold', name: 'Золотая рамка', data: svgDataURI(`
      <svg xmlns='http://www.w3.org/2000/svg' width='1200' height='1200'>
        <defs>
          <linearGradient id='g1' x1='0' x2='1'>
            <stop offset='0' stop-color='#ffd78a'/>
            <stop offset='1' stop-color='#f59e0b'/>
          </linearGradient>
        </defs>
        <rect x='20' y='20' width='1160' height='1160' fill='none' stroke='url(#g1)' stroke-width='60' rx='80' ry='80' stroke-linecap='round' stroke-linejoin='round'/>
        <g opacity='0.08' fill='#fff'>
          <ellipse cx='260' cy='170' rx='220' ry='26'/>
        </g>
      </svg>
    `) },

    { id: 'frame-ice', name: 'Ледяная рамка', data: svgDataURI(`
      <svg xmlns='http://www.w3.org/2000/svg' width='1200' height='1200'>
        <rect x='16' y='16' width='1168' height='1168' fill='none' stroke='#bfe6ff' stroke-width='36' rx='60' ry='60' opacity='0.95'/>
        <g fill='#e6f7ff' opacity='0.06'><rect x='16' y='16' width='1168' height='1168' rx='60'/></g>
        <g fill='#fff' opacity='0.08'><circle cx='80' cy='80' r='12'/><circle cx='1100' cy='120' r='8'/></g>
      </svg>
    `) },

    { id: 'frame-holly', name: 'Рождественская', data: svgDataURI(`
      <svg xmlns='http://www.w3.org/2000/svg' width='1200' height='1200'>
        <rect x='30' y='30' width='1140' height='1140' fill='none' stroke='#f7faf3' stroke-width='38' rx='60'/>
        <!-- holly corner -->
        <g transform='translate(60,60)'>
          <path d='M40 10 C10 10, 10 40, 40 40 C30 60, 60 60, 70 40 C100 40, 100 10, 70 10 C60 -10, 30 -10, 40 10 Z' fill='#0f5132'/>
          <circle cx='60' cy='20' r='6' fill='#ff2d55'/>
        </g>
      </svg>
    `) }
  ],

  hats: [
    { id:'hat-1', name:'Шапка 1', data: svgDataURI(`
      <svg xmlns='http://www.w3.org/2000/svg' width='600' height='400'>
        <g transform='translate(0,0)'>
          <path d='M40 200 C180 40, 420 40, 560 200 L560 260 C420 120, 180 120, 40 260 Z' fill='#c62828' stroke='#8b1c1c' stroke-width='6'/>
          <rect x='40' y='240' width='520' height='60' rx='30' fill='#fff'/>
          <circle cx='560' cy='200' r='28' fill='#fff'/>
        </g>
      </svg>
    `) },

    { id:'hat-2', name:'Шапка-мех', data: svgDataURI(`
      <svg xmlns='http://www.w3.org/2000/svg' width='600' height='400'>
        <g>
          <path d='M30 200 C200 60, 400 60, 570 200 L570 270 C400 120, 200 120, 30 270 Z' fill='#8b0000'/>
          <rect x='30' y='240' width='540' height='60' rx='30' fill='#fff'/>
          <circle cx='100' cy='230' r='20' fill='#fff'/>
        </g>
      </svg>
    `) },

    { id:'hat-3', name:'Колпак', data: svgDataURI(`
      <svg xmlns='http://www.w3.org/2000/svg' width='600' height='400'>
        <g>
          <path d='M10 220 C140 40, 460 40, 590 220 L590 270 C460 90, 140 90, 10 270 Z' fill='#b71c1c' opacity='0.95'/>
          <rect x='10' y='250' width='580' height='46' rx='22' fill='#fff'/>
        </g>
      </svg>
    `) }
  ],

  decor: [
    { id:'snow-1', name:'Снежинка', data: svgDataURI(`
      <svg xmlns='http://www.w3.org/2000/svg' width='220' height='220'><g fill='none' stroke='#fff' stroke-width='6' stroke-linecap='round' opacity='0.95'>
        <g transform='translate(110,110)'>
          <path d='M0 -60 L0 60' />
          <path d='M-52 -30 L52 30' />
          <path d='M-52 30 L52 -30' />
          <circle cx='0' cy='0' r='6' fill='#fff'/>
        </g>
      </g></svg>
    `) },
    { id:'star-1', name:'Звезда', data: svgDataURI(`
      <svg xmlns='http://www.w3.org/2000/svg' width='200' height='200'><polygon points='100,10 120,70 185,75 135,115 150,175 100,140 50,175 65,115 15,75 80,70' fill='#ffd54f' stroke='#ffb300' stroke-width='6'/></svg>
    `) },
    { id:'orn-1', name:'Игрушка', data: svgDataURI(`
      <svg xmlns='http://www.w3.org/2000/svg' width='180' height='220'>
        <ellipse cx='90' cy='110' rx='60' ry='70' fill='#ff6f91' stroke='#c94c74' stroke-width='5'/>
        <rect x='70' y='30' width='40' height='18' rx='6' fill='#222' opacity='0.2'/>
      </svg>
    `) },
    { id:'garland', name:'Гирлянда', data: svgDataURI(`
      <svg xmlns='http://www.w3.org/2000/svg' width='440' height='60'>
        <g>
          <path d='M0 30 Q60 0 120 30 T240 30 T360 30 T480 30' fill='none' stroke='#ffd54f' stroke-width='6' stroke-linecap='round' />
        </g>
      </svg>
    `) }
  ]
};

/* helper: создаёт data-uri из SVG текста */
function svgDataURI(svgText){
  const encoded = encodeURIComponent(svgText).replace(/'/g,"%27").replace(/"/g,"%22");
  return `data:image/svg+xml;charset=utf-8,${encoded}`;
}

/* ---------- редактор: структура данных ---------- */
const canvas = document.getElementById('preview');
const ctx = canvas.getContext('2d', { alpha: true });
const dropzone = document.getElementById('dropzone');

let photo = null; // {img, x,y, scale, rotation, w,h}
let elements = []; // overlay elements: {id,type,img,x,y,scale,rotation,selected,originW,originH}

let selectedElement = null;
let dragging = false;
let dragOffset = {x:0,y:0};
let mode = 'idle'; // 'pan-photo' or 'drag-elem'

/* UI refs */
const fileInput = document.getElementById('fileInput');
const framesList = document.getElementById('framesList');
const hatsList = document.getElementById('hatsList');
const scaleRange = document.getElementById('scaleRange');
const rotateRange = document.getElementById('rotateRange');
const downloadBtn = document.getElementById('downloadBtn');
const resetBtn = document.getElementById('resetBtn');

/* init thumbs */
function makeThumb(imgSrc, title){
  const d = document.createElement('div'); d.className='thumb';
  const im = document.createElement('img'); im.src = imgSrc; im.alt=title;
  d.appendChild(im);
  return d;
}

/* populate lists */
ASSETS.frames.forEach(a=>{
  const t = makeThumb(a.data, a.name);
  t.title = a.name;
  t.onclick = ()=> addElementFromAsset(a,'frame');
  framesList.appendChild(t);
});
ASSETS.hats.forEach(a=>{
  const t = makeThumb(a.data, a.name);
  t.title = a.name;
  t.onclick = ()=> addElementFromAsset(a,'hat');
  hatsList.appendChild(t);
});
ASSETS.decor.forEach(a=>{
  const t = makeThumb(a.data, a.name);
  t.title = a.name;
  t.onclick = ()=> addElementFromAsset(a,'decor');
  hatsList.appendChild(t);
});

/* file load */
fileInput.addEventListener('change', (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = function(ev){
    loadPhotoFromURL(ev.target.result);
  };
  reader.readAsDataURL(f);
});

/* drag & drop */
['dragenter','dragover'].forEach(ev=>{
  dropzone.addEventListener(ev, e => { e.preventDefault(); dropzone.style.outline='2px dashed rgba(255,255,255,0.12)'; });
});
['dragleave','drop'].forEach(ev=>{
  dropzone.addEventListener(ev, e => { e.preventDefault(); dropzone.style.outline='none'; });
});
dropzone.addEventListener('drop', e=>{
  const f = e.dataTransfer.files && e.dataTransfer.files[0];
  if(f){
    const reader = new FileReader();
    reader.onload = ev => loadPhotoFromURL(ev.target.result);
    reader.readAsDataURL(f);
  }
});

/* load photo helper */
function loadPhotoFromURL(dataUrl){
  const img = new Image();
  img.onload = ()=>{
    const cw = canvas.width, ch = canvas.height;
    // center and fit
    const scale = Math.max( (cw/2)/img.width, (ch/2)/img.height );
    photo = {
      img: img,
      x: cw/2,
      y: ch/2,
      scale: Math.max(scale, 0.8),
      rotation: 0,
      w: img.width,
      h: img.height
    };
    elements = elements.filter(el=>el.type==='frame' ? true : true); // keep existing overlays
    selectedElement = null;
    render();
  };
  img.src = dataUrl;
}

/* add element from asset */
function addElementFromAsset(asset, type){
  const im = new Image();
  im.onload = ()=>{
    const el = {
      id: asset.id + '-' + Date.now(),
      type: type,
      img: im,
      x: canvas.width/2,
      y: canvas.height/2,
      scale: (type==='frame'? 1.0 : 0.5),
      rotation: 0,
      originW: im.width,
      originH: im.height,
      selected: false
    };
    // if frame - put to bottom of overlays (draw last so it is on top) — for convenience frames drawn last to be top decorative; but frames usually should be topmost
    elements.push(el);
    selectElement(el.id);
    render();
  };
  im.src = asset.data;
}

/* select element by id */
function selectElement(id){
  selectedElement = elements.find(el=>el.id===id) || null;
  elements.forEach(el=> el.selected = (el.id===id));
  updateControls();
  render();
}

/* update controls from selected */
function updateControls(){
  if(selectedElement){
    scaleRange.value = selectedElement.scale;
    rotateRange.value = selectedElement.rotation;
  } else {
    scaleRange.value = 1;
    rotateRange.value = 0;
  }
}

/* canvas events: dragging photo or elements */
canvas.addEventListener('mousedown', e=>{
  const pos = getEventPos(e);
  // check elements top-down to select
  for(let i=elements.length-1;i>=0;i--){
    const el = elements[i];
    if (hitTestElement(el,pos)){
      selectElement(el.id);
      mode = 'drag-elem';
      dragging = true;
      dragOffset.x = pos.x - el.x;
      dragOffset.y = pos.y - el.y;
      return;
    }
  }
  // if clicked empty and there is photo - pan photo
  if(photo){
    mode = 'pan-photo';
    dragging = true;
    dragOffset.x = pos.x - photo.x;
    dragOffset.y = pos.y - photo.y;
    selectedElement = null;
    elements.forEach(el=>el.selected=false);
    updateControls();
    render();
  }
});
window.addEventListener('mouseup', ()=>{ dragging=false; mode='idle'; });
window.addEventListener('mousemove', (e)=>{
  if(!dragging) return;
  const pos = getEventPos(e);
  if(mode==='pan-photo' && photo){
    photo.x = pos.x - dragOffset.x;
    photo.y = pos.y - dragOffset.y;
    render();
  } else if(mode==='drag-elem' && selectedElement){
    selectedElement.x = pos.x - dragOffset.x;
    selectedElement.y = pos.y - dragOffset.y;
    render();
  }
});

/* wheel for zoom when hovering canvas */
canvas.addEventListener('wheel', e=>{
  e.preventDefault();
  const delta = -e.deltaY;
  const factor = 1 + (delta>0? 0.06 : -0.06);
  // if an element selected and cursor close to it -> scale that element, otherwise scale photo
  const pos = getEventPos(e);
  let target = null;
  if(selectedElement && distance(pos, {x:selectedElement.x,y:selectedElement.y}) < Math.max(selectedElement.originW, selectedElement.originH)*selectedElement.scale/2 ){
    target = selectedElement;
  }
  if(target){
    target.scale = Math.max(0.1, Math.min(4, target.scale * factor));
    updateControls();
    render();
  } else if(photo){
    photo.scale = Math.max(0.1, Math.min(6, photo.scale * factor));
    render();
  }
});

/* helpers */
function getEventPos(e){
  const rect = canvas.getBoundingClientRect();
  const x = (e.clientX - rect.left) * (canvas.width/rect.width);
  const y = (e.clientY - rect.top) * (canvas.height/rect.height);
  return {x,y};
}
function distance(a,b){ const dx=a.x-b.x, dy=a.y-b.y; return Math.sqrt(dx*dx+dy*dy); }

/* element hit test (approx using bounding box rotated) */
function hitTestElement(el, pos){
  const w = el.originW * el.scale;
  const h = el.originH * el.scale;
  // approximate as axis-aligned box around element center (rotation ignored for simplicity)
  return pos.x >= el.x - w/2 && pos.x <= el.x + w/2 && pos.y >= el.y - h/2 && pos.y <= el.y + h/2;
}

/* rendering */
function clearCanvas(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  // optional background grid founds are not necessary
}
function render(){
  clearCanvas();
  // draw background (transparent)
  // draw photo centered with transform
  if(photo){
    ctx.save();
    ctx.translate(photo.x, photo.y);
    ctx.rotate(photo.rotation * Math.PI/180);
    const dw = photo.w * photo.scale;
    const dh = photo.h * photo.scale;
    ctx.drawImage(photo.img, -dw/2, -dh/2, dw, dh);
    ctx.restore();
  } else {
    // hint when no photo
    ctx.save();
    ctx.fillStyle = 'rgba(255,255,255,0.04)';
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = '#fff';
    ctx.globalAlpha = 0.85;
    ctx.font = '16px sans-serif';
    ctx.textAlign='center';
    ctx.fillText('Загрузите фото — перетащите или нажмите "Загрузить фото"', canvas.width/2, canvas.height/2);
    ctx.restore();
  }

  // draw elements in order they were added
  elements.forEach((el)=>{
    ctx.save();
    ctx.translate(el.x, el.y);
    ctx.rotate(el.rotation * Math.PI/180);
    const dw = el.originW * el.scale;
    const dh = el.originH * el.scale;
    ctx.drawImage(el.img, -dw/2, -dh/2, dw, dh);
    if(el.selected){
      // draw selection frame
      ctx.strokeStyle = 'rgba(245,158,11,0.8)';
      ctx.lineWidth = 3;
      ctx.strokeRect(-dw/2, -dh/2, dw, dh);
    }
    ctx.restore();
  });

  // draw top vignette subtle
  ctx.save();
  var g = ctx.createLinearGradient(0,0,0,canvas.height);
  g.addColorStop(0,'rgba(0,0,0,0.02)');
  g.addColorStop(1,'rgba(0,0,0,0.25)');
  ctx.fillStyle = g;
  ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.restore();
}

/* controls: scaleRange & rotateRange affect selected element if any, otherwise photo */
scaleRange.addEventListener('input', ()=>{
  const v = parseFloat(scaleRange.value);
  if(selectedElement){
    selectedElement.scale = v;
  } else if(photo){
    photo.scale = v;
  }
  render();
});
rotateRange.addEventListener('input', ()=>{
  const v = parseFloat(rotateRange.value);
  if(selectedElement){
    selectedElement.rotation = v;
  } else if(photo){
    photo.rotation = v;
  }
  render();
});

/* select elements by clicking thumbs: when added we select them already.
   Allow deleting element by double click on canvas if clicking on element */
canvas.addEventListener('dblclick', e=>{
  const pos = getEventPos(e);
  for(let i=elements.length-1;i>=0;i--){
    if(hitTestElement(elements[i], pos)){
      // remove
      elements.splice(i,1);
      selectedElement = null;
      updateControls();
      render();
      return;
    }
  }
});

/* select by clicking on thumbs: we set that on add. But also allow clicking existing previews in lists,
   already done when generating thumbs. */

downloadBtn.addEventListener('click', async ()=>{
  // export at 1080x1080
  const size = 1080;
  const out = document.createElement('canvas');
  out.width = size; out.height = size;
  const octx = out.getContext('2d');

  // background transparent, optional subtle bg
  octx.fillStyle = 'rgba(0,0,0,0)';
  octx.fillRect(0,0,size,size);

  // if photo exists - we need to map from preview canvas to output canvas
  if(photo){
    // compute scale factor between preview and output
    const sf = size / canvas.width;
    octx.save();
    octx.translate(photo.x*sf, photo.y*sf);
    octx.rotate(photo.rotation * Math.PI/180);
    const dw = photo.w * photo.scale * sf;
    const dh = photo.h * photo.scale * sf;
    octx.drawImage(photo.img, -dw/2, -dh/2, dw, dh);
    octx.restore();
  }

  // draw elements
  elements.forEach(el=>{
    octx.save();
    octx.translate(el.x * (size/canvas.width), el.y * (size/canvas.height));
    octx.rotate(el.rotation * Math.PI/180);
    const dw = el.originW * el.scale * (size/canvas.width);
    const dh = el.originH * el.scale * (size/canvas.height);
    octx.drawImage(el.img, -dw/2, -dh/2, dw, dh);
    octx.restore();
  });

  // create image and trigger download
  out.toBlob(blob=>{
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'expertsoft_avatar.png';
    document.body.appendChild(a);
    a.click();
    a.remove();
  }, 'image/png');
});

/* reset */
resetBtn.addEventListener('click', ()=>{
  photo = null; elements = []; selectedElement = null;
  render();
});

/* keyboard shortcuts */
window.addEventListener('keydown', e=>{
  if(e.key === 'Delete' || e.key === 'Backspace'){
    if(selectedElement){
      elements = elements.filter(el=>el.id !== selectedElement.id);
      selectedElement = null;
      render();
    }
  }
});

/* utility: initial render */
render();

/* click on thumbnails selects last added - but also allow clicking existing element in list - already covered */

/* expose function to select element after adding */
function selectLastElement(){
  if(elements.length) selectElement(elements[elements.length-1].id);
}

/* When adding element via asset we already select it; but we should update range controls when hover or select.
   Add a small observer to update ranges when selection changes (calls updateControls already) */

/* END */
</script>
</body>
</html>
