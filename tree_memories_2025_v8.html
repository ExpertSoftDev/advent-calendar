<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Елка воспоминаний 2025</title>
<style>
:root{
  --text: rgba(255,255,255,.95);
  --muted: rgba(255,255,255,.74);
  --card: rgba(255,255,255,.12);
  --stroke: rgba(255,255,255,.18);
  --shadow: rgba(0,0,0,.45);
  --radius: 18px;
  --gold:#ffd36e;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
  color: var(--text);
  min-height:100vh;
  overflow-x:hidden;
  background:
    radial-gradient(860px 600px at 18% 14%, rgba(255, 176, 110, .32), transparent 62%),
    radial-gradient(720px 520px at 86% 16%, rgba(255, 92, 178, .22), transparent 58%),
    radial-gradient(840px 620px at 56% 92%, rgba(60, 220, 255, .16), transparent 62%),
    radial-gradient(1000px 800px at 52% 50%, rgba(0,0,0,.16), transparent 66%),
    linear-gradient(160deg, #2b1c24, #162a28 55%, #101722);
}
body::before{
  content:"";
  position:fixed; inset:0;
  background-image:
    radial-gradient(circle at 20% 10%, rgba(255,255,255,.06), transparent 55%),
    radial-gradient(circle at 80% 30%, rgba(255,255,255,.05), transparent 60%),
    radial-gradient(circle at 40% 80%, rgba(255,255,255,.04), transparent 60%);
  mix-blend-mode: overlay;
  pointer-events:none;
  opacity:.6;
}
.bokeh{position:fixed; inset:-20px; pointer-events:none; z-index:0; opacity:.82}
.bokeh i{
  position:absolute; border-radius:999px;
  background: rgba(255,255,255,.16);
  box-shadow: 0 0 30px rgba(255, 214, 160, .22);
  animation: floaty 10s infinite ease-in-out;
}
@keyframes floaty{
  0%,100%{transform:translateY(0) scale(1); opacity:.24}
  50%{transform:translateY(-22px) scale(1.22); opacity:.74}
}
.wrap{position:relative; z-index:1; max-width:1120px; margin:0 auto; padding:28px 18px 44px}
header{display:flex; align-items:flex-end; justify-content:space-between; gap:16px; margin-bottom:18px}
.title{display:flex; flex-direction:column; gap:8px}
h1{margin:0; font-size: clamp(22px, 3vw, 34px); letter-spacing:.2px}
.sub{margin:0; color: var(--muted); line-height:1.35; max-width:78ch}

.pill{
  display:flex; gap:10px; align-items:center;
  padding: 10px 12px;
  border-radius:999px;
  background: var(--card);
  border: 1px solid var(--stroke);
  box-shadow: 0 16px 40px var(--shadow);
  backdrop-filter: blur(10px);
  white-space:nowrap;
}
.pill strong{font-weight:900}
.btn{
  border:1px solid rgba(255,255,255,.18);
  background: rgba(255,255,255,.06);
  color: var(--text);
  padding: 10px 12px;
  border-radius: 14px;
  cursor:pointer;
}
.btn:hover{filter:brightness(1.06)}
.btn.danger{
  border-color: rgba(255,120,120,.38);
  background: rgba(255,120,120,.12);
  padding: 8px 10px;
  border-radius: 999px;
}

.grid{display:grid; grid-template-columns:1.1fr .9fr; gap:16px; align-items:stretch}
@media (max-width:900px){
  header{flex-direction:column; align-items:flex-start}
  .pill{width:100%; justify-content:space-between}
  .grid{grid-template-columns:1fr}
}

.panel{
  background: var(--card);
  border: 1px solid var(--stroke);
  border-radius: var(--radius);
  box-shadow: 0 24px 60px var(--shadow);
  overflow:hidden;
  position:relative;
  backdrop-filter: blur(12px);
}
.panelHead{
  display:flex; align-items:center; justify-content:space-between;
  padding: 14px 16px;
  border-bottom: 1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.05);
  gap:10px;
}
.panelHead .left{display:flex; gap:10px; align-items:center}
.badge{width:10px; height:10px; border-radius:999px; background: var(--gold); box-shadow: 0 0 0 4px rgba(255,211,110,.16)}
.panelHead h2{margin:0; font-size:16px}
.panelHead .hint{color: var(--muted); font-size:13px}
.panelBody{padding:16px}

.treeStage{height:610px; display:flex; align-items:flex-end; justify-content:center; padding:14px 12px 22px; position:relative}
@media (max-width:900px){.treeStage{height:560px}}
.treeWrap{width:min(560px,100%); height:580px; position:relative; display:flex; align-items:flex-end; justify-content:center}
.treeSvg{width:min(560px,100%); height:580px; filter: drop-shadow(0 28px 46px rgba(0,0,0,.34))}

.hung{
  position:absolute;
  width: 52px;
  height: 52px;
  transform: translate(-50%,-50%);
  cursor:pointer;
  filter: drop-shadow(0 16px 20px rgba(0,0,0,.38));
  user-select:none;
}
.hung svg{width:52px; height:52px}

.ornamentRack{display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:12px}
@media (max-width:520px){.ornamentRack{grid-template-columns: repeat(3, minmax(0,1fr))}}
.ornBtn{
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  padding: 12px 12px;
  border-radius:16px;
  background: rgba(255,255,255,.07);
  border: 1px solid rgba(255,255,255,.16);
  color: var(--text);
  cursor:pointer;
  transition: transform .12s ease, background .12s ease, border-color .12s ease;
}
.ornBtn:hover{transform: translateY(-2px); background: rgba(255,255,255,.10); border-color: rgba(255,255,255,.24)}
.ornBtn[disabled]{cursor:default; opacity:.45; transform:none}
.ico{width:26px; height:26px; display:inline-flex; align-items:center; justify-content:center; filter: drop-shadow(0 10px 16px rgba(0,0,0,.25)); flex:0 0 auto}
.ico svg{width:26px; height:26px}
.qLabel{font-weight:800; color: rgba(255,255,255,.86)}

/* modal */
.modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding:18px;
  background: rgba(0,0,0,.55); backdrop-filter: blur(7px); z-index:50;
}
.modal.show{display:flex}
.dialog{width:min(740px,100%); border-radius:22px; background: rgba(16,18,26,.88);
  border:1px solid rgba(255,255,255,.16); box-shadow:0 36px 90px rgba(0,0,0,.62); overflow:hidden;
}
.dialogHead{padding:14px 16px; display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
  border-bottom:1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.04);
}
.qnum{font-weight:900; color: rgba(255,255,255,.92)}
.qtext{margin:6px 0 0; color: rgba(255,255,255,.95); line-height:1.4; font-size:18px}
.close{background:transparent; border:1px solid rgba(255,255,255,.18); color: var(--text); border-radius:14px; padding:8px 10px; cursor:pointer}
.dialogBody{padding:14px 16px 16px; display:flex; flex-direction:column; gap:12px}
.hint2{margin:0; color: var(--muted); font-size:13px; line-height:1.35}
.actions{display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap}
.btn.primary{background: linear-gradient(135deg, rgba(255,211,110,.28), rgba(255, 45, 61, .16)); border-color: rgba(255,255,255,.24)}

/* bulbs */
.bulb{
  position:absolute;
  width: 11px; height:11px;
  border-radius: 999px;
  opacity:.86;
  pointer-events:none;
  box-shadow: 0 0 18px rgba(255, 205, 150, .38);
  animation: glow 3.6s infinite ease-in-out;
}
@keyframes glow{
  0%,100%{transform:scale(1); filter:brightness(1); opacity:.56}
  50%{transform:scale(1.5); filter:brightness(1.35); opacity:.98}
}
body.party .bulb{animation: partyGlow 1.05s infinite ease-in-out; opacity:.96; box-shadow: 0 0 28px rgba(255,255,255,.42)}
@keyframes partyGlow{
  0%,100%{transform:scale(1); filter:brightness(1.08)}
  50%{transform:scale(2.0); filter:brightness(1.65)}
}
#topStar path{filter: drop-shadow(0 10px 14px rgba(0,0,0,.30))}
body.party #topStar path{animation: starFlash .9s infinite ease-in-out}
@keyframes starFlash{0%,100%{opacity:.88; filter:brightness(1.15)} 50%{opacity:1; filter:brightness(1.7)}}
</style>
</head>
<body>
<div class="bokeh" aria-hidden="true" id="bokeh"></div>

<div class="wrap">
  <header>
    <div class="title">
      <h1>Елка воспоминаний 2025</h1>
      <p class="sub">Каждая игрушка — это вопрос про 2025 год. Мы предлагаем тебе брать игрушку, отвечать на вопрос и вешать игрушку на елку.</p>
    </div>
    <div class="pill" aria-live="polite">
      <span>Украшено:</span>
      <strong><span id="doneCount">0</span> / 20</strong>
      <button class="btn danger" id="resetBtn" title="Сбросить прогресс на этом устройстве">Сброс</button>
    </div>
  </header>

  <div class="grid">
    <section class="panel">
      <div class="panelHead">
        <div class="left"><span class="badge"></span><h2>Елка</h2></div>
        <span class="hint">Чем больше игрушек — тем красивее елка ✨</span>
      </div>

      <div class="treeStage">
        <div class="treeWrap">

          <!-- Kid-style applique triangle tree -->
          <svg class="treeSvg" viewBox="0 0 560 580" aria-hidden="true">
            <defs>
              <linearGradient id="g1" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0%" stop-color="#2bbf86"/><stop offset="100%" stop-color="#0c5a3f"/>
              </linearGradient>
              <linearGradient id="g2" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0%" stop-color="#27b47e"/><stop offset="100%" stop-color="#0a533a"/>
              </linearGradient>
              <linearGradient id="g3" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0%" stop-color="#22a874"/><stop offset="100%" stop-color="#084b34"/>
              </linearGradient>

              <filter id="cutShadow" x="-20%" y="-20%" width="140%" height="140%">
                <feDropShadow dx="0" dy="10" stdDeviation="8" flood-color="rgba(0,0,0,.30)"/>
              </filter>
              <filter id="paperEdge" x="-10%" y="-10%" width="120%" height="120%">
                <feDropShadow dx="0" dy="0" stdDeviation="2" flood-color="rgba(255,255,255,.18)"/>
              </filter>

              <linearGradient id="tr" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0%" stop-color="#a86a41"/><stop offset="100%" stop-color="#6f3f25"/>
              </linearGradient>

              <radialGradient id="starGrad" cx="50%" cy="35%" r="70%">
                <stop offset="0%" stop-color="#fff7d4"/><stop offset="55%" stop-color="#ffd36e"/><stop offset="100%" stop-color="#ffb84d"/>
              </radialGradient>
            </defs>

            <!-- star on top -->
            <g id="topStar" transform="translate(280 56)">
              <path d="M0 -34 L11 -3 L46 0 L19 20 L28 54 L0 36 L-28 54 L-19 20 L-46 0 L-11 -3 Z"
                    fill="url(#starGrad)" stroke="rgba(255,255,255,.52)" stroke-width="2.2">
                <animate attributeName="opacity" values="0.84;1;0.84" dur="4.4s" repeatCount="indefinite"/>
              </path>
            </g>

            <g filter="url(#cutShadow)">
              <polygon points="280,98 125,262 445,262" fill="url(#g1)" filter="url(#paperEdge)"/>
              <polygon points="276,208 88,432 478,432" fill="url(#g2)" filter="url(#paperEdge)"/>
              <polygon points="282,334 38,562 528,562" fill="url(#g3)" filter="url(#paperEdge)"/>
            </g>

            <!-- paper-ish stripes -->
            <path d="M150 250 L410 250" stroke="rgba(255,255,255,.10)" stroke-width="8" stroke-linecap="round"/>
            <path d="M130 420 L450 420" stroke="rgba(255,255,255,.08)" stroke-width="10" stroke-linecap="round"/>
            <path d="M105 548 L475 548" stroke="rgba(255,255,255,.07)" stroke-width="12" stroke-linecap="round"/>

            </svg>

          <div id="bulbsLayer" style="position:absolute; inset:0; pointer-events:none;"></div>
          <div id="hungLayer" style="position:absolute; inset:0;"></div>
        </div>
      </div>
    </section>

    <section class="panel">
      <div class="panelHead">
        <div class="left"><span class="badge" style="background: rgba(0,214,255,.95); box-shadow: 0 0 0 4px rgba(0,214,255,.14)"></span><h2>Игрушки</h2></div>
        <span class="hint">20 вопросов</span>
      </div>
      <div class="panelBody">
        <div class="ornamentRack" id="rack"></div>
      </div>
    </section>
  </div>
</div>

<div class="modal" id="modal" role="dialog" aria-modal="true" aria-labelledby="qTitle">
  <div class="dialog">
    <div class="dialogHead">
      <div>
        <div class="qnum" id="qTitle">Вопрос <span id="qIndex">1</span> из 20</div>
        <p class="qtext" id="qText"></p>
      </div>
      <button class="close" id="closeBtn" aria-label="Закрыть">✕</button>
    </div>
    <div class="dialogBody">
      <p class="hint2">Ответь устно/про себя — и когда будешь готов(а), нажми «Повесить игрушку».</p>
      <div class="actions">
        <button class="btn" id="skipBtn">Пока пропущу</button>
        <button class="btn primary" id="saveBtn">Повесить игрушку</button>
      </div>
    </div>
  </div>
</div>

<script>
const QUESTIONS = ["Если описать 2025 год одним словом, каким оно будет и почему именно оно?", "Какое решение в 2025 далось тебе тяжелее всего и было ли оно верным?", "Что ты откладывал(а) почти весь год, хотя знал(а), что это важно?", "Кому ты был(а) благодарен(на), но так и не сказал(а) об этом вслух?", "Если бы у 2025 был саундтрек, какая песня в нем звучала бы чаще всего?", "Что в 2025 давало тебе ощущение устойчивости?", "В чем ты стал(а) увереннее как профессионал?", "Какая привычка осталась с тобой, несмотря ни на что?", "Какой напиток в 2025 ты пил(а) чаще всего?", "Какая фотография из 2025 - твоя любимая?", "Какой день в этом году запомнился просто потому, что было хорошо?", "За что ты можешь честно сказать себе \"я молодец\"?", "Если бы нужно было оставить себе один совет из 2025, каким бы он был?", "Что в этом году оказалось проще, чем ты себе представлял(а)?", "Какое переживание в 2025 для тебя было самым важным?", "Что из простого приносило тебе радость чаще, чем ты ожидал(а)?", "Что из этого года ты с легкостью отпускаешь?", "Если бы 2025 можно было поблагодарить - за что именно?", "Какой момент года хочется поставить на паузу и почему?", "Если бы 2025 был мемом, то каким?"];
const POSITIONS = [[50, 22], [42, 28], [58, 28], [38, 36], [50, 36], [62, 36], [34, 46], [46, 46], [54, 46], [66, 46], [38, 58], [50, 58], [62, 58], [34, 68], [46, 68], [54, 68], [66, 68], [38, 80], [50, 80], [62, 80]];
const TYPES = ["ball", "gift", "ball", "bell", "snowflake2", "ball", "gift", "ball", "bell", "star", "snowflake2", "gift", "ball", "ball", "bell", "star", "snowflake2", "gift", "ball", "bell"];
const COLORS = ["#ff2d3d", "#1f6bff", "#ffd100", "#ff7a00", "#00d6ff", "#9d4dff", "#00d18f", "#ff2fb3", "#ffffff", "#ff4db8"];
const STORAGE_KEY = "tree_progress_2025_v8";
const BOOT_KEY = "tree_progress_boot_v8";

const rack = document.getElementById("rack");
const modal = document.getElementById("modal");
const qIndexEl = document.getElementById("qIndex");
const qTextEl = document.getElementById("qText");
const doneCountEl = document.getElementById("doneCount");
const resetBtn = document.getElementById("resetBtn");
const closeBtn = document.getElementById("closeBtn");
const skipBtn = document.getElementById("skipBtn");
const saveBtn = document.getElementById("saveBtn");
const hungLayer = document.getElementById("hungLayer");
const bulbsLayer = document.getElementById("bulbsLayer");
const bokeh = document.getElementById("bokeh");

let currentIndex = null;

function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return {done: {}};
    const p = JSON.parse(raw);
    return {done: p.done || {}};
  }catch(e){ return {done: {}}; }
}
function saveState(state){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
function countDone(state){ return Object.keys(state.done).length; }
function updateCounter(state){
  const c = countDone(state);
  doneCountEl.textContent = String(c);
  if(c === QUESTIONS.length) document.body.classList.add("party");
  else document.body.classList.remove("party");
}
function randColor(i){ return COLORS[i % COLORS.length]; }

function hook(){
  return `<path d="M50 12 C50 8, 56 8, 56 12 C56 16, 50 16, 50 20" fill="none" stroke="rgba(255,255,255,.45)" stroke-width="4" stroke-linecap="round"/>
          <path d="M50 20 v10" stroke="rgba(255,255,255,.45)" stroke-width="4" stroke-linecap="round"/>`;
}

function ornamentSvg(type, i){
  const fill = randColor(i);
  const stroke = "rgba(255,255,255,.36)";
  const shine = "rgba(255,255,255,.60)";

  if(type === "ball"){
    return `<svg viewBox="0 0 100 100" aria-hidden="true">
      ${hook()}
      <path d="M44 30 h12 a8 8 0 0 1 8 8 v6 H36 v-6 a8 8 0 0 1 8-8 Z" fill="rgba(255,255,255,.26)"/>
      <circle cx="50" cy="66" r="26" fill="${fill}" stroke="${stroke}" stroke-width="4"/>
      <path d="M38 60 C44 50, 58 48, 66 54" stroke="${shine}" stroke-width="7" stroke-linecap="round" opacity=".85"/>
      <path d="M36 74 C44 86, 64 88, 72 78" stroke="rgba(0,0,0,.18)" stroke-width="8" stroke-linecap="round" opacity=".22"/>
    </svg>`;
  }

  if(type === "gift"){
    return `<svg viewBox="0 0 100 100" aria-hidden="true">
      ${hook()}
      <rect x="20" y="36" width="60" height="52" rx="12" fill="${fill}" stroke="${stroke}" stroke-width="4"/>
      <rect x="46" y="36" width="8" height="52" fill="rgba(255,255,255,.34)"/>
      <rect x="20" y="56" width="60" height="8" fill="rgba(255,255,255,.24)"/>
      <path d="M50 36 C41 28, 30 22, 30 16 C30 10, 36 8, 40 10 C46 13, 49 22, 50 26
               C51 22, 54 13, 60 10 C64 8, 70 10, 70 16 C70 22, 59 28, 50 36 Z"
            fill="rgba(255,255,255,.30)"/>
    </svg>`;
  }

  if(type === "bell"){
    return `<svg viewBox="0 0 100 100" aria-hidden="true">
      ${hook()}
      <rect x="43" y="20" width="14" height="10" rx="5" fill="rgba(255,255,255,.26)"/>
      <path d="M50 28 C39 28, 30 36, 30 48 L30 62 C30 78, 20 80, 20 86 L80 86 C80 80, 70 78, 70 62 L70 48 C70 36, 61 28, 50 28 Z"
            fill="${fill}" stroke="${stroke}" stroke-width="4"/>
      <circle cx="50" cy="88" r="7" fill="rgba(255,255,255,.30)"/>
      <path d="M38 54 C44 46, 56 44, 64 48" stroke="${shine}" stroke-width="6" stroke-linecap="round"/>
    </svg>`;
  }

  if(type === "snowflake2"){
    return `<svg viewBox="0 0 100 100" aria-hidden="true">
      ${hook()}
      <g stroke="${fill}" stroke-width="5" stroke-linecap="round" fill="none">
        <path d="M50 26 v48"/>
        <path d="M26 50 h48"/>
        <path d="M33 33 l34 34"/>
        <path d="M67 33 l-34 34"/>
        <path d="M50 26 l-6 6"/><path d="M50 26 l6 6"/>
        <path d="M50 74 l-6 -6"/><path d="M50 74 l6 -6"/>
        <path d="M26 50 l6 -6"/><path d="M26 50 l6 6"/>
        <path d="M74 50 l-6 -6"/><path d="M74 50 l-6 6"/>
      </g>
      <circle cx="50" cy="50" r="10" fill="rgba(255,255,255,.10)" stroke="${fill}" stroke-width="4"/>
    </svg>`;
  }

  /* star */

  return `<svg viewBox="0 0 100 100" aria-hidden="true">
    ${hook()}
    <path d="M50 22 L60 44 L84 46 L66 60 L72 82 L50 70 L28 82 L34 60 L16 46 L40 44 Z"
          fill="${fill}" stroke="${stroke}" stroke-width="4"/>
  </svg>`;
}

function renderRack(state){
  rack.innerHTML = "";
  QUESTIONS.forEach((q, i)=>{
    const btn = document.createElement("button");
    btn.className = "ornBtn";
    btn.type = "button";
    btn.innerHTML = `<span class="ico">${ornamentSvg(TYPES[i], i)}</span><span class="qLabel">Вопрос ${i+1}</span>`;
    if(state.done[i]){ btn.disabled = true; btn.title="Уже на елке"; }
    else { btn.title="Открыть вопрос"; btn.addEventListener("click", ()=>openQuestion(i)); }
    rack.appendChild(btn);
  });
}

function renderTree(state){
  hungLayer.innerHTML = "";
  Object.keys(state.done).map(Number).sort((a,b)=>a-b).forEach(i=>{
    const pos = POSITIONS[i];
    const el = document.createElement("div");
    el.className = "hung";
    el.style.left = pos[0] + "%";
    el.style.top  = pos[1] + "%";
    el.innerHTML = ornamentSvg(TYPES[i], i);
    el.title = "Нажми, чтобы снова открыть вопрос";
    el.addEventListener("click", ()=>openQuestion(i, true));
    hungLayer.appendChild(el);
  });
}

function openQuestion(i, alreadyDone=false){
  currentIndex = i;
  qIndexEl.textContent = String(i+1);
  qTextEl.textContent = QUESTIONS[i];
  saveBtn.textContent = alreadyDone ? "Игрушка уже на елке" : "Повесить игрушку";
  saveBtn.disabled = !!alreadyDone;
  modal.classList.add("show");
}
function closeModal(){ modal.classList.remove("show"); currentIndex=null; saveBtn.disabled=false; }
function saveCurrent(){
  if(currentIndex===null) return;
  const state = loadState();
  state.done[currentIndex] = true;
  saveState(state);
  updateCounter(state);
  renderRack(state);
  renderTree(state);
  closeModal();
}
function resetAll(){
  const ok = confirm("Сбросить прогресс украшения елки на этом устройстве?");
  if(!ok) return;
  localStorage.removeItem(STORAGE_KEY);
  init();
}

/* diagonal garland bulbs */
const bulbPoints = [
  [165,225],[210,245],[255,265],[300,285],[345,305],[390,325],
  [140,350],[200,375],[260,400],[320,425],[380,450],[440,475],
  [115,490],[195,512],[275,532],[355,548],[435,560]
];

function renderBulbs(){
  bulbsLayer.innerHTML = "";
  bulbPoints.forEach((p)=>{
    const d = document.createElement("div");
    d.className = "bulb";
    d.style.left = (p[0]/560*100).toFixed(2) + "%";
    d.style.top  = (p[1]/580*100).toFixed(2) + "%";
    d.style.background = "rgba(255, 205, 150, .95)";
    d.style.animationDelay = (Math.random()*1.2).toFixed(2) + "s";
    bulbsLayer.appendChild(d);
  });
}

function applyPartyColors(){
  const bulbs = Array.from(document.querySelectorAll(".bulb"));
  let t = 0;
  setInterval(()=>{
    if(!document.body.classList.contains("party")) return;
    bulbs.forEach((b, i)=>{ b.style.background = COLORS[(i + t) % COLORS.length]; });
    t = (t + 1) % COLORS.length;
  }, 220);
}

function renderBokeh(){
  bokeh.innerHTML = "";
  const n = 30;
  for(let i=0;i<n;i++){
    const el = document.createElement("i");
    const size = 12 + Math.random()*26;
    el.style.width = size+"px"; el.style.height = size+"px";
    el.style.left = (Math.random()*100).toFixed(2)+"%";
    el.style.top  = (Math.random()*100).toFixed(2)+"%";
    el.style.opacity = (0.16 + Math.random()*0.46).toFixed(2);
    el.style.animationDelay = (Math.random()*2.5).toFixed(2)+"s";
    el.style.animationDuration = (8 + Math.random()*8).toFixed(2)+"s";
    bokeh.appendChild(el);
  }
}

function init(){
  // First run of this specific build: start with a clean, empty tree (no carried progress).
  try{
    if(!localStorage.getItem(BOOT_KEY)){
      localStorage.removeItem(STORAGE_KEY);
      localStorage.setItem(BOOT_KEY, "1");
    }
  }catch(e){}
renderBulbs();
  renderBokeh();
  const state = loadState();
  updateCounter(state);
  renderRack(state);
  renderTree(state);
  applyPartyColors();
}

modal.addEventListener("click", (e)=>{ if(e.target===modal) closeModal(); });
document.getElementById("closeBtn").addEventListener("click", closeModal);
document.getElementById("skipBtn").addEventListener("click", closeModal);
document.getElementById("saveBtn").addEventListener("click", saveCurrent);
document.getElementById("resetBtn").addEventListener("click", resetAll);
window.addEventListener("keydown", (e)=>{ if(e.key==="Escape" && modal.classList.contains("show")) closeModal(); });

init();
</script>
</body>
</html>
