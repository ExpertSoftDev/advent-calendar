<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Адвент Expert Soft — Новогодний редактор аватарок</title>
<style>
  :root{
    --max-w:1100px;
    --accent:#f59e0b;
    --muted:#cbd5e1;
    --glass: rgba(255,255,255,0.06);
    --glass-2: rgba(0,0,0,0.45);
    --card-radius:20px;
  }

  html,body{height:100%;margin:0;font-family: system-ui, -apple-system, "SF Pro Text","Segoe UI", Roboto, Arial, sans-serif; -webkit-font-smoothing:antialiased; background:#071025; color:#fff;}

/* Full-page abstract holiday background + subtle bokeh */
  body::before{
    content:"";
    position:fixed; inset:0; z-index:-3;
    background:
      radial-gradient(ellipse at 10% 20%, rgba(255,255,255,0.03) 0, transparent 15%),
      radial-gradient(ellipse at 90% 80%, rgba(191,219,254,0.05) 0, transparent 18%),
      linear-gradient(135deg,#071025 0%, #0f172a 30%, #071025 100%);
    background-size:cover;
    filter: saturate(1.05) contrast(1.02);
  }

/* animated subtle snow (canvas fallback unnecessary) */
  .snow {
    pointer-events:none;
    position:fixed; inset:0; z-index:-2;
    background:
      radial-gradient(circle at 10% 10%, rgba(255,255,255,0.02), transparent 15%),
      radial-gradient(circle at 80% 20%, rgba(255,255,255,0.01), transparent 12%);
  }

/* center app pane, full viewport, no page scroll */
  .app {
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:24px;
    box-sizing:border-box;
  }

  /* glass panel */
  .panel {
    width: min(var(--max-w), calc(100% - 48px));
    max-height: calc(100vh - 48px);
    border-radius: calc(var(--card-radius) + 8px);
    background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
    border: 1px solid rgba(255,255,255,0.04);
    box-shadow: 0 30px 80px rgba(2,6,23,0.7);
    padding: 22px;
    box-sizing:border-box;
    display:flex;
    gap:18px;
    overflow: hidden;
    backdrop-filter: blur(8px) saturate(1.05);
  }

  /* header */
  .header {
    display:flex;
    align-items:center;
    gap:12px;
  }
  .brand h1{margin:0;font-size:20px;letter-spacing:0.06em;text-transform:uppercase;}
  .brand p{margin:0;color:var(--muted);font-size:13px;}

  /* layout: left - editor, right - tools; responsive stacks column */
  .layout {
    display:grid;
    grid-template-columns: 640px 1fr;
    gap:18px;
    width:100%;
  }

  @media (max-width:980px){
    .layout{ grid-template-columns: 1fr; }
  }

  /* editor */
  .editor {
    background: linear-gradient(180deg, rgba(0,0,0,0.35), rgba(0,0,0,0.45));
    border-radius: 14px;
    padding:12px;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    gap:10px;
    min-height:580px;
    box-sizing:border-box;
  }

  .canvas-wrap {
    width: 560px;
    height: 560px;
    border-radius:12px;
    background: linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));
    position:relative;
    overflow:hidden;
    display:flex;
    align-items:center;
    justify-content:center;
    border:1px solid rgba(255,255,255,0.02);
  }

  @media (max-width:980px){
    .canvas-wrap{ width:92%; height:calc(92vw); max-height:640px; }
  }

  canvas#preview{ display:block; width:100%; height:100%; background:transparent; border-radius:10px; }

  .controls { display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin-top:8px; }

  .btn {
    background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
    border:1px solid rgba(255,255,255,0.06);
    color:#fff;
    padding:8px 12px;
    border-radius:10px;
    cursor:pointer;
    font-weight:600;
    transition: transform .12s ease;
  }
  .btn:hover{ transform: translateY(-3px); }

  input[type="file"]{ display:none; }

  /* tools column */
  .tools {
    display:flex;
    flex-direction:column;
    gap:12px;
    max-height: calc(100vh - 120px);
    overflow:auto;
    padding-right:6px;
    box-sizing:border-box;
  }

  .card {
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:12px;
    padding:10px;
    border:1px solid rgba(255,255,255,0.03);
  }

  .card h4 { margin:0 0 8px 0; font-size:15px; }
  .thumbs { display:flex; gap:8px; flex-wrap:wrap; }
  .thumb { width:72px; height:72px; border-radius:8px; overflow:hidden; display:flex; align-items:center; justify-content:center; cursor:pointer; border:1px solid rgba(255,255,255,0.03); background:rgba(255,255,255,0.01); }
  .thumb img{ max-width:100%; max-height:100%; display:block; }

  .thumb.selected { outline:3px solid rgba(245,158,11,0.22); box-shadow: 0 8px 24px rgba(245,158,11,0.04); }

  .small { color:var(--muted); font-size:13px; }

  .tools .card .row { display:flex; gap:8px; align-items:center; margin-top:6px; }

  /* sliders */
  input[type="range"]{ width:100%; }

  /* helpers */
  .muted{ color:var(--muted); font-size:13px; }

  footer { margin-top:10px; display:flex; justify-content:center; gap:8px; }

  /* ensure inside scroll on narrow screens */
  @media (max-width:600px){
    .panel{ padding:12px; }
  }
</style>
</head>
<body>
  <div class="snow" aria-hidden="true"></div>
  <div class="app" role="application" aria-label="Новогодний редактор аватарок">
    <div class="panel" role="main">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
        <div class="header">
          <div class="brand">
            <h1>Адвент Expert Soft</h1>
            <p>Создавайте новогодние аватарки — загрузите фото, добавьте фильтр, рамку и украшения</p>
          </div>
        </div>
        <div class="muted">Экспорт: 1080 × 1080 PNG</div>
      </div>

      <div class="layout">
        <!-- EDITOR -->
        <section class="editor" aria-label="Редактор">
          <div class="canvas-wrap" id="dropzone" title="Перетащите фото сюда">
            <canvas id="preview" width="720" height="720" aria-label="Предпросмотр аватарки"></canvas>
          </div>

          <div class="controls">
            <label class="btn" for="fileInput">Загрузить фото
              <input id="fileInput" type="file" accept="image/*">
            </label>
            <button id="resetBtn" class="btn">Сбросить</button>
            <button id="downloadBtn" class="btn" title="Скачать итоговую картинку">Скачать аватарку</button>
          </div>

          <div class="muted" style="font-size:13px; text-align:center; width:92%;">Перетаскивайте фото внутри холста, колесико мыши — масштаб. Для украшений: клик — выбрать, перетащить — переместить, колесико — масштабировать, двойной клик — удалить.</div>
        </section>

        <!-- TOOLS -->
        <aside class="tools" aria-label="Инструменты">
          <div class="card">
            <h4>Фильтры (тон и настроение)</h4>
            <div class="thumbs" id="filtersList"></div>
            <div class="row muted small" style="margin-top:8px;">Фильтр накладывается на фото; рамка — поверх всего.</div>
          </div>

          <div class="card">
            <h4>Рамки</h4>
            <div class="thumbs" id="framesList"></div>
            <div class="row" style="margin-top:8px;">
              <button id="clearFrame" class="btn" style="padding:6px 8px;">Убрать рамку</button>
            </div>
          </div>

          <div class="card">
            <h4>Шапки</h4>
            <div class="thumbs" id="hatsList"></div>
          </div>

          <div class="card">
            <h4>Украшения</h4>
            <div class="thumbs" id="decorList"></div>
          </div>

          <div class="card">
            <h4>Инструменты трансформации</h4>
            <div style="display:flex;gap:8px;align-items:center;">
              <div style="width:100%;">
                <div class="small">Масштаб / Поворот (для выбранного элемента)</div>
                <input id="scaleRange" type="range" min="0.2" max="3" step="0.01" value="1">
                <input id="rotateRange" type="range" min="-180" max="180" step="1" value="0">
              </div>
            </div>
            <div class="muted small" style="margin-top:6px;">Если элемент не выбран — изменение влияет на фото.</div>
          </div>

        </aside>
      </div>

    </div>
  </div>

<script>
/* ---------- helper to create data-uri for SVG ---------- */
function svgDataURI(svg){ return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg); }

/* ---------- assets (improved festive SVGs) ---------- */
const ASSETS = {
  filters: [
    { id:'flt-none', name:'Без фильтра', fn: null, thumb: '#fff' },
    { id:'flt-warm', name:'Тёплое сияние', fn: (ctx,w,h)=>{ ctx.fillStyle='rgba(255,200,120,0.12)'; ctx.fillRect(0,0,w,h); ctx.globalCompositeOperation='soft-light'; } , thumb:'#ffd8a8' },
    { id:'flt-cold', name:'Холодный декабрь', fn: (ctx,w,h)=>{ ctx.fillStyle='rgba(140,190,255,0.12)'; ctx.fillRect(0,0,w,h); ctx.globalCompositeOperation='overlay'; } , thumb:'#cfe6ff' },
    { id:'flt-xmas', name:'Рождественский', fn: (ctx,w,h)=>{ ctx.fillStyle='rgba(220,120,120,0.08)'; ctx.fillRect(0,0,w,h); ctx.globalCompositeOperation='overlay'; } , thumb:'#ffdfe0' },
    { id:'flt-vintage', name:'Винтаж', fn: (ctx,w,h)=>{ ctx.fillStyle='rgba(220,200,160,0.06)'; ctx.fillRect(0,0,w,h); ctx.globalCompositeOperation='multiply'; } , thumb:'#efe0c8' },
  ],

  frames: [
    { id:'frame-snow', name:'Снежная рамка', data: svgDataURI(`
      <svg xmlns='http://www.w3.org/2000/svg' width='1600' height='1600'>
        <defs>
          <filter id='g' x='-50%' y='-50%' width='200%' height='200%'><feGaussianBlur stdDeviation='8' result='b'/></filter>
        </defs>
        <rect x='10' y='10' width='1580' height='1580' rx='80' ry='80' fill='none' stroke='#f7fbff' stroke-width='40' opacity='0.7'/>
        <g fill='#fff' opacity='0.95'>
          <circle cx='100' cy='120' r='10'/>
          <circle cx='1500' cy='120' r='8'/>
          <circle cx='200' cy='1500' r='6'/>
        </g>
        <!-- snowflake ornaments -->
        <g transform='translate(120,80)' fill='none' stroke='#e9f6ff' stroke-width='6'>
          <g transform='scale(1.1)'>
            <path d='M0 0 L12 -18 M0 0 L-12 -18 M0 0 L0 20 M0 0 L18 6 M0 0 L-18 6' stroke-linecap='round'/>
          </g>
        </g>
      </svg>
    `)},

    { id:'frame-frost', name:'Морозный узор', data: svgDataURI(`
      <svg xmlns='http://www.w3.org/2000/svg' width='1600' height='1600'>
        <rect x='8' y='8' width='1584' height='1584' rx='80' fill='none' stroke='url(#g1)' stroke-width='28'/>
        <defs>
          <linearGradient id='g1'><stop offset='0' stop-color='#cfefff'/><stop offset='1' stop-color='#9fd3ff'/></linearGradient>
        </defs>
        <g fill='#fff' opacity='0.06'>
          <path d='M80 80 q40 22 80 0 t80 0' />
        </g>
      </svg>
    `)},

    { id:'frame-lights', name:'Гирлянда', data: svgDataURI(`
      <svg xmlns='http://www.w3.org/2000/svg' width='1600' height='1600'>
        <rect x='0' y='0' width='1600' height='1600' fill='none' />
        <g stroke-linecap='round' stroke-width='12' stroke='#ffecb3' fill='none' opacity='0.95'>
          <path d='M60 140 q240 -80 480 0 t480 0 t480 0' stroke='#ffd54f'/>
        </g>
        <g fill='#ffd54f' opacity='0.95'>
          <circle cx='200' cy='110' r='12'/><circle cx='680' cy='110' r='12'/><circle cx='1160' cy='110' r='12'/>
        </g>
        <rect x='28' y='28' width='1544' height='1544' rx='80' stroke='#fff' stroke-opacity='0.06' fill='none'/>
      </svg>
    `)},

    { id:'frame-holly', name:'Еловые уголки', data: svgDataURI(`
      <svg xmlns='http://www.w3.org/2000/svg' width='1600' height='1600'>
        <rect x='24' y='24' width='1552' height='1552' rx='80' fill='none'/>
        <g transform='translate(40,40)'>
          <path d='M40 60 C10 40, 10 10, 60 10 C80 -10, 120 10, 110 40 C140 40,160 60,120 80 z' fill='#0f5132'/>
          <circle cx='88' cy='40' r='8' fill='#ff2d55'/>
        </g>
        <g transform='translate(1200,1200) scale(-1,-1)'>
          <path d='M40 60 C10 40, 10 10, 60 10 C80 -10, 120 10, 110 40 C140 40,160 60,120 80 z' fill='#0f5132'/>
          <circle cx='88' cy='40' r='8' fill='#ff2d55'/>
        </g>
      </svg>
    `)}
  ],

  hats: [
    { id:'hat-santa', name:'Классическая шапка', data: svgDataURI(`
      <svg xmlns='http://www.w3.org/2000/svg' width='800' height='520'>
        <g>
          <path d='M40 320 C120 120, 680 120, 760 320 L760 380 C680 200, 120 200, 40 380 Z' fill='#cc1414'/>
          <rect x='40' y='360' width='720' height='80' rx='40' fill='#fff'/>
          <circle cx='760' cy='320' r='44' fill='#fff'/>
          <g opacity='0.08'><ellipse cx='160' cy='140' rx='120' ry='18' fill='#fff'/></g>
        </g>
      </svg>
    `)},

    { id:'hat-fur', name:'Пуховая шапка', data: svgDataURI(`
      <svg xmlns='http://www.w3.org/2000/svg' width='800' height='520'>
        <g>
          <path d='M40 300 C140 60, 660 60, 760 300 L760 340 C660 120,140 120,40 340 Z' fill='#b71c1c'/>
          <rect x='24' y='320' width='752' height='86' rx='40' fill='#fff'/>
          <circle cx='680' cy='300' r='34' fill='#fff'/>
        </g>
      </svg>
    `)},

    { id:'hat-elf', name:'Эльфийская', data: svgDataURI(`
      <svg xmlns='http://www.w3.org/2000/svg' width='800' height='520'>
        <g>
          <path d='M40 310 C200 70, 600 70, 760 310 L760 350 C600 120,200 120,40 350 Z' fill='#9b2b2b'/>
          <rect x='40' y='340' width='720' height='46' rx='22' fill='#fff'/>
        </g>
      </svg>
    `)}
  ],

  decor: [
    { id:'dec-snowflake', name:'Снежинка', data: svgDataURI(`
      <svg xmlns='http://www.w3.org/2000/svg' width='260' height='260'>
        <g transform='translate(130,130)' stroke='#fff' stroke-width='6' stroke-linecap='round' stroke-linejoin='round' fill='none'>
          <path d='M0 -70 L0 70'/>
          <path d='M-48 -38 L48 38'/>
          <path d='M-48 38 L48 -38'/>
          <circle cx='0' cy='0' r='6' fill='#fff'/>
        </g>
      </svg>
    `)},

    { id:'dec-star', name:'Звёздочка', data: svgDataURI(`
      <svg xmlns='http://www.w3.org/2000/svg' width='200' height='200'>
        <polygon points='100,10 120,70 185,75 135,115 150,175 100,140 50,175 65,115 15,75 80,70' fill='#ffd54f' stroke='#ffb300' stroke-width='4'/>
      </svg>
    `)},

    { id:'dec-bauble', name:'Игрушка', data: svgDataURI(`
      <svg xmlns='http://www.w3.org/2000/svg' width='160' height='220'>
        <ellipse cx='80' cy='110' rx='62' ry='72' fill='#ff6f91' stroke='#c94c74' stroke-width='6'/>
        <rect x='66' y='20' width='28' height='18' rx='6' fill='#ffd54f'/>
      </svg>
    `)},

    { id:'dec-garland', name:'Гирлянда', data: svgDataURI(`
      <svg xmlns='http://www.w3.org/2000/svg' width='420' height='80'>
        <path d='M0 40 Q40 0 80 40 T160 40 T240 40 T320 40 T400 40' stroke='#ffd54f' stroke-width='6' fill='none' stroke-linecap='round'/>
      </svg>
    `)}
  ]
};

/* ---------- Editor core (based on previous but updated) ---------- */
const canvas = document.getElementById('preview');
const ctx = canvas.getContext('2d', { alpha: true });

let photo = null; // {img, x,y, scale, rotation, w,h}
let elements = []; // overlay elements: {id,type,img,x,y,scale,rotation,selected,originW,originH}
let frame = null; // frame element {img, id, originW,...}
let currentFilter = ASSETS.filters[0]; // default none
let selectedElement = null;
let dragging = false;
let dragOffset = {x:0,y:0};
let mode = 'idle';

const fileInput = document.getElementById('fileInput');
const framesList = document.getElementById('framesList');
const hatsList = document.getElementById('hatsList');
const decorList = document.getElementById('decorList');
const filtersList = document.getElementById('filtersList');
const scaleRange = document.getElementById('scaleRange');
const rotateRange = document.getElementById('rotateRange');
const downloadBtn = document.getElementById('downloadBtn');
const resetBtn = document.getElementById('resetBtn');
const clearFrameBtn = document.getElementById('clearFrame');

/* helper create thumbnail element */
function makeThumb(src, title){
  const d = document.createElement('div'); d.className='thumb';
  const im = document.createElement('img'); im.src = src; im.alt = title; im.title = title;
  d.appendChild(im);
  return d;
}

/* populate filters thumbs */
ASSETS.filters.forEach(f=>{
  const d = document.createElement('div'); d.className='thumb';
  d.title = f.name;
  d.style.display='flex'; d.style.alignItems='center'; d.style.justifyContent='center';
  d.style.background = f.thumb ? f.thumb : 'rgba(255,255,255,0.03)';
  d.innerHTML = `<div style="font-size:11px;color:#072336;padding:6px;border-radius:6px;background:rgba(255,255,255,0.9);">${f.name.split(' ')[0]}</div>`;
  d.onclick = ()=> { currentFilter = f; renderThumbs(); render(); };
  filtersList.appendChild(d);
});

/* populate frames */
ASSETS.frames.forEach(a=>{
  const t = makeThumb(a.data, a.name);
  t.onclick = ()=> {
    loadImageFromDataURI(a.data).then(img=>{
      frame = { id: a.id, img: img, originW: img.width, originH: img.height };
      render();
      highlightSelectedThumb(framesList, t);
    });
  };
  framesList.appendChild(t);
});

/* clear frame */
clearFrameBtn.addEventListener('click', ()=>{
  frame = null; render(); clearSelection(framesList);
});

/* populate hats & decor */
ASSETS.hats.forEach(a=>{
  const t = makeThumb(a.data, a.name);
  t.onclick = ()=> addElementFromAsset(a,'hat', t);
  hatsList.appendChild(t);
});
ASSETS.decor.forEach(a=>{
  const t = makeThumb(a.data, a.name);
  t.onclick = ()=> addElementFromAsset(a,'decor', t);
  decorList.appendChild(t);
});

/* helpers to highlight selected thumb (visual) */
function highlightSelectedThumb(container, thumbEl){
  Array.from(container.children).forEach(c=>c.classList.remove('selected'));
  if(thumbEl) thumbEl.classList.add('selected');
}
function clearSelection(container){ Array.from(container.children).forEach(c=>c.classList.remove('selected')); }

/* load image from data URI into Image */
function loadImageFromDataURI(dataURI){
  return new Promise(res=>{
    const im = new Image();
    im.onload = ()=> res(im);
    im.src = dataURI;
  });
}

/* file load */
fileInput.addEventListener('change', e=>{
  const f = e.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = function(ev){ loadPhotoFromURL(ev.target.result); };
  reader.readAsDataURL(f);
});

/* drag & drop area */
const dropzone = document.getElementById('dropzone');
['dragenter','dragover'].forEach(ev=> dropzone.addEventListener(ev, e=>{ e.preventDefault(); dropzone.style.outline='2px dashed rgba(255,255,255,0.08)'; }));
['dragleave','drop'].forEach(ev=> dropzone.addEventListener(ev, e=>{ e.preventDefault(); dropzone.style.outline='none'; }));
dropzone.addEventListener('drop', e=>{
  const f = e.dataTransfer.files && e.dataTransfer.files[0];
  if(f){ const reader = new FileReader(); reader.onload = ev=> loadPhotoFromURL(ev.target.result); reader.readAsDataURL(f); }
});

/* load photo */
function loadPhotoFromURL(dataUrl){
  const img = new Image();
  img.onload = ()=>{
    const cw = canvas.width, ch = canvas.height;
    const scale = Math.max( (cw/2)/img.width, (ch/2)/img.height );
    photo = { img: img, x: cw/2, y: ch/2, scale: Math.max(scale, 0.9), rotation:0, w: img.width, h: img.height };
    selectedElement = null; elements = elements.filter(e=>e.type==='frame'?false:true);
    render();
  };
  img.src = dataUrl;
}

/* add overlay element */
function addElementFromAsset(asset, type, thumbEl){
  loadImageFromDataURI(asset.data).then(im=>{
    const el = {
      id: asset.id + '-' + Date.now(),
      type: type,
      img: im,
      x: canvas.width/2,
      y: canvas.height/2,
      scale: (type==='hat'? 0.7 : 0.4),
      rotation: 0,
      originW: im.width,
      originH: im.height,
      selected: false
    };
    elements.push(el);
    selectElement(el.id);
    render();
    // highlight gesture on the source thumb
    if(thumbEl){ highlightSelectedThumb( (type==='hat'? hatsList : decorList), thumbEl); setTimeout(()=>thumbEl.classList.remove('selected'), 450); }
  });
}

/* select element by id */
function selectElement(id){
  selectedElement = elements.find(el=>el.id===id) || null;
  elements.forEach(el=> el.selected = (el.id===id));
  updateControls();
  render();
}

/* update controls */
function updateControls(){
  if(selectedElement){
    scaleRange.value = selectedElement.scale;
    rotateRange.value = selectedElement.rotation;
  } else if(photo){
    scaleRange.value = photo.scale;
    rotateRange.value = photo.rotation;
  } else {
    scaleRange.value = 1; rotateRange.value = 0;
  }
}

/* mouse events on canvas */
canvas.addEventListener('mousedown', e=>{
  const pos = getEventPos(e);
  // element top-down
  for(let i=elements.length-1;i>=0;i--){
    if(hitTestElement(elements[i], pos)){
      selectElement(elements[i].id);
      mode='drag-elem'; dragging=true;
      dragOffset.x = pos.x - elements[i].x; dragOffset.y = pos.y - elements[i].y;
      return;
    }
  }
  // click photo -> pan
  if(photo){
    mode='pan-photo'; dragging=true;
    dragOffset.x = pos.x - photo.x; dragOffset.y = pos.y - photo.y;
    selectedElement = null; elements.forEach(el=>el.selected=false); updateControls(); render();
  }
});
window.addEventListener('mouseup', ()=>{ dragging=false; mode='idle'; });
window.addEventListener('mousemove', (e)=>{
  if(!dragging) return;
  const pos = getEventPos(e);
  if(mode==='pan-photo' && photo){
    photo.x = pos.x - dragOffset.x; photo.y = pos.y - dragOffset.y; render();
  } else if(mode==='drag-elem' && selectedElement){
    selectedElement.x = pos.x - dragOffset.x; selectedElement.y = pos.y - dragOffset.y; render();
  }
});

/* wheel zoom */
canvas.addEventListener('wheel', e=>{ e.preventDefault();
  const delta = -e.deltaY; const factor = 1 + (delta>0?0.06:-0.06);
  const pos = getEventPos(e);
  let target = null;
  if(selectedElement && distance(pos, {x:selectedElement.x,y:selectedElement.y}) < Math.max(selectedElement.originW, selectedElement.originH)*selectedElement.scale/2 ) target = selectedElement;
  if(target){ target.scale = clamp(target.scale * factor, 0.1, 6); updateControls(); render(); }
  else if(photo){ photo.scale = clamp(photo.scale * factor, 0.1, 6); updateControls(); render(); }
});

/* hit test approx */
function hitTestElement(el,pos){
  const w = el.originW * el.scale; const h = el.originH * el.scale;
  return pos.x >= el.x - w/2 && pos.x <= el.x + w/2 && pos.y >= el.y - h/2 && pos.y <= el.y + h/2;
}

/* utilities */
function getEventPos(e){
  const rect = canvas.getBoundingClientRect();
  const x = (e.clientX - rect.left) * (canvas.width/rect.width);
  const y = (e.clientY - rect.top) * (canvas.height/rect.height);
  return {x,y};
}
function distance(a,b){ const dx=a.x-b.x, dy=a.y-b.y; return Math.sqrt(dx*dx+dy*dy); }
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

/* rendering */
function clearCanvas(){ ctx.clearRect(0,0,canvas.width,canvas.height); }
function render(){
  clearCanvas();

  // background subtle
  ctx.save();
  ctx.fillStyle = 'rgba(0,0,0,0)';
  ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.restore();

  // photo
  if(photo){
    ctx.save();
    ctx.translate(photo.x, photo.y);
    ctx.rotate(photo.rotation * Math.PI/180);
    const dw = photo.w * photo.scale;
    const dh = photo.h * photo.scale;
    ctx.drawImage(photo.img, -dw/2, -dh/2, dw, dh);
    ctx.restore();
  } else {
    ctx.save();
    ctx.fillStyle = 'rgba(255,255,255,0.03)';
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = '#fff'; ctx.globalAlpha = 0.9; ctx.font = '16px sans-serif'; ctx.textAlign='center';
    ctx.fillText('Загрузите фото — перетащите или нажмите "Загрузить фото"', canvas.width/2, canvas.height/2);
    ctx.restore();
  }

  // apply filter (if any)
  if(currentFilter && currentFilter.fn){
    ctx.save();
    // apply via provided fn - but restore globalCompositeOperation after
    currentFilter.fn(ctx, canvas.width, canvas.height);
    ctx.globalCompositeOperation = 'source-over';
    ctx.restore();
  }

  // draw elements (hats/decor) in order
  elements.forEach((el, index)=>{
    ctx.save();
    ctx.translate(el.x, el.y);
    ctx.rotate(el.rotation * Math.PI/180);
    const dw = el.originW * el.scale;
    const dh = el.originH * el.scale;
    ctx.drawImage(el.img, -dw/2, -dh/2, dw, dh);
    if(el.selected){
      ctx.strokeStyle = 'rgba(245,158,11,0.85)'; ctx.lineWidth = 3;
      ctx.strokeRect(-dw/2, -dh/2, dw, dh);
    }
    ctx.restore();
  });

  // draw frame on top
  if(frame){
    ctx.save();
    // frame image drawn to cover full canvas
    const fw = frame.originW, fh = frame.originH;
    const sf = Math.max(canvas.width / fw, canvas.height / fh);
    const dw = fw * sf, dh = fh * sf;
    ctx.drawImage(frame.img, (canvas.width - dw)/2, (canvas.height - dh)/2, dw, dh);
    ctx.restore();
  }

  // vignette
  ctx.save();
  const g = ctx.createLinearGradient(0,0,0,canvas.height);
  g.addColorStop(0,'rgba(0,0,0,0.02)');
  g.addColorStop(1,'rgba(0,0,0,0.18)');
  ctx.fillStyle = g; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.restore();
}

/* controls handlers */
scaleRange.addEventListener('input', ()=>{ const v = parseFloat(scaleRange.value); if(selectedElement){ selectedElement.scale = v; } else if(photo){ photo.scale = v; } render(); });
rotateRange.addEventListener('input', ()=>{ const v = parseFloat(rotateRange.value); if(selectedElement){ selectedElement.rotation = v; } else if(photo){ photo.rotation = v; } render(); });

/* delete on double click */
canvas.addEventListener('dblclick', e=>{
  const pos = getEventPos(e);
  for(let i=elements.length-1;i>=0;i--){
    if(hitTestElement(elements[i], pos)){
      elements.splice(i,1); selectedElement=null; updateControls(); render(); return;
    }
  }
});

/* download as 1080x1080 */
downloadBtn.addEventListener('click', ()=>{
  const size = 1080;
  const out = document.createElement('canvas'); out.width = size; out.height = size; const octx = out.getContext('2d');

  // clear
  octx.clearRect(0,0,size,size);

  // draw photo scaled to output
  if(photo){
    const sf = size / canvas.width;
    octx.save();
    octx.translate(photo.x * sf, photo.y * sf);
    octx.rotate(photo.rotation * Math.PI/180);
    const dw = photo.w * photo.scale * sf;
    const dh = photo.h * photo.scale * sf;
    octx.drawImage(photo.img, -dw/2, -dh/2, dw, dh);
    octx.restore();
  }

  // apply filter
  if(currentFilter && currentFilter.fn){
    octx.save();
    // crude approach: call the filter function on temp ctx by mapping coordinates
    currentFilter.fn(octx, size, size);
    octx.globalCompositeOperation = 'source-over';
    octx.restore();
  }

  // draw elements
  elements.forEach(el=>{
    octx.save();
    octx.translate(el.x * (size/canvas.width), el.y * (size/canvas.height));
    octx.rotate(el.rotation * Math.PI/180);
    const dw = el.originW * el.scale * (size/canvas.width);
    const dh = el.originH * el.scale * (size/canvas.height);
    octx.drawImage(el.img, -dw/2, -dh/2, dw, dh);
    octx.restore();
  });

  // draw frame last (cover)
  if(frame){
    const fw = frame.originW, fh = frame.originH;
    const sf = Math.max(size / fw, size / fh);
    const dw = fw * sf, dh = fh * sf;
    octx.drawImage(frame.img, (size - dw)/2, (size - dh)/2, dw, dh);
  }

  out.toBlob(blob=>{
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'expertsoft_avatar.png';
    document.body.appendChild(a);
    a.click(); a.remove();
  }, 'image/png');
});

/* reset */
resetBtn.addEventListener('click', ()=>{ photo = null; elements = []; frame = null; currentFilter = ASSETS.filters[0]; selectedElement=null; render(); clearSelection(framesList); renderThumbs(); });

/* keyboard delete */
window.addEventListener('keydown', e=>{
  if(e.key === 'Delete' || e.key === 'Backspace'){
    if(selectedElement){ elements = elements.filter(el=>el.id !== selectedElement.id); selectedElement=null; updateControls(); render(); }
  }
});

/* utility */
function renderThumbs(){
  // highlight current filter
  Array.from(filtersList.children).forEach((c, i)=>{
    if(ASSETS.filters[i] && ASSETS.filters[i].id === currentFilter.id) c.classList.add('selected'); else c.classList.remove('selected');
  });
}
renderThumbs();

/* selection helper when adding element */
function selectElementById(id){ selectElement(id); }

function selectElement(id){ selectedElement = elements.find(el=>el.id===id) || null; elements.forEach(el=> el.selected = (el.id===id)); updateControls(); render(); }

/* when user clicks thumb to add, selection is handled at creation */

/* helper: clamp etc already defined earlier */

/* initial render */
render();

/* Expose some functions to console for debugging (optional) */
window._editor = { elements, setFrame: (fid)=>{ const f = ASSETS.frames.find(x=>x.id===fid); if(f){ loadImageFromDataURI(f.data).then(img=>{frame={id:f.id,img:img,originW:img.width,originH:img.height}; render();}); } } };

/* End of script */
</script>
</body>
</html>
